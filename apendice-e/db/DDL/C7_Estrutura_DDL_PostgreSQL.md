<h2 align="center">CAD-MOTOTAXISTA - Documentação Técnica</h2>

### Estrutura DDL do Banco de Dados – PostgreSQL

Este script define a **estrutura completa do banco de dados do sistema CADMOTOTAXISTA**, utilizando o **PostgreSQL** como sistema gerenciador.  
O conteúdo foi desenvolvido para garantir **integridade referencial**, **consistência dos dados** e **rastreabilidade das operações** realizadas pela aplicação.  

O script segue o padrão de **transação controlada (`BEGIN ... END`)**, assegurando que todas as instruções de criação de tabelas, índices e chaves estrangeiras sejam executadas de forma atômica — ou seja, completamente ou não executadas, preservando a integridade do banco.

A modelagem contempla as principais entidades do domínio da Secretaria Municipal de Trânsito e Transporte (SMTT), incluindo:

- **Condutor**, **Cliente** e **Funcionário** – entidades centrais de cadastro e operação;  
- **Motocicleta**, **MotoModelo** e **MotoMarca** – entidades que representam o parque de veículos cadastrados;  
- **Usuário**, **Perfis** e **Tokens** – componentes responsáveis pelo controle de autenticação e autorização;  
- **AuditoriaRegistros** – estrutura destinada ao registro e rastreamento de ações do sistema;  
- **RegistroClienteContato** – tabela responsável por armazenar o histórico de contatos via WhatsApp entre clientes e condutores.  

> 💡 **Observação:** Este script foi versionado e é executado automaticamente pelo **Flyway**, ferramenta de controle de versões de banco de dados adotada pelo sistema CADMOTOTAXISTA.

---

```sql
BEGIN;


CREATE TABLE IF NOT EXISTS public.auditoria_registros
(
    data_criacao timestamp(6) without time zone,
    data_evento timestamp(6) without time zone NOT NULL,
    data_modificacao timestamp(6) without time zone,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    usuario_id bigint,
    numero_de_ordem character varying(10) COLLATE pg_catalog."default" NOT NULL,
    acao character varying(25) COLLATE pg_catalog."default" NOT NULL,
    descricao_acao character varying(25) COLLATE pg_catalog."default" NOT NULL,
    criado_por character varying(255) COLLATE pg_catalog."default",
    email_funcionario character varying(255) COLLATE pg_catalog."default" NOT NULL,
    modificado_por character varying(255) COLLATE pg_catalog."default",
    nome_condutor character varying(255) COLLATE pg_catalog."default" NOT NULL,
    nome_funcionario character varying(255) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT auditoria_registros_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.cliente
(
    data_nascimento date NOT NULL,
    contato_fk bigint,
    endereco_fk bigint,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    id_usuario bigint NOT NULL,
    nome character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT cliente_pkey PRIMARY KEY (id),
    CONSTRAINT cliente_contato_fk_key UNIQUE (contato_fk),
    CONSTRAINT cliente_endereco_fk_key UNIQUE (endereco_fk),
    CONSTRAINT cliente_id_usuario_key UNIQUE (id_usuario)
);

CREATE TABLE IF NOT EXISTS public.cnh
(
    categoria character varying(2) COLLATE pg_catalog."default" NOT NULL,
    data_vencimento date NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    numero_habilitacao character varying(11) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT cnh_pkey PRIMARY KEY (id),
    CONSTRAINT cnh_numero_habilitacao_key UNIQUE (numero_habilitacao)
);

CREATE TABLE IF NOT EXISTS public.condutor
(
    cadastro_ativo boolean NOT NULL,
    data_nascimento date NOT NULL,
    data_vencimento_alvara date,
    cnh_fk bigint,
    contato_fk bigint,
    data_criacao timestamp(6) without time zone,
    data_modificacao timestamp(6) without time zone,
    endereco_fk bigint,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    motocicleta_fk bigint,
    ponto_fk bigint,
    numero_ordem character varying(10) COLLATE pg_catalog."default",
    tipo_sanguineo character varying(11) COLLATE pg_catalog."default",
    modalidade_condutor character varying(12) COLLATE pg_catalog."default" NOT NULL,
    cpf character varying(15) COLLATE pg_catalog."default" NOT NULL,
    rg character varying(15) COLLATE pg_catalog."default" NOT NULL,
    apelido character varying(50) COLLATE pg_catalog."default",
    criado_por character varying(255) COLLATE pg_catalog."default",
    modificado_por character varying(255) COLLATE pg_catalog."default",
    nome character varying(255) COLLATE pg_catalog."default" NOT NULL,
    nome_mae character varying(255) COLLATE pg_catalog."default",
    nome_pai character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT condutor_pkey PRIMARY KEY (id),
    CONSTRAINT condutor_cnh_fk_key UNIQUE (cnh_fk),
    CONSTRAINT condutor_contato_fk_key UNIQUE (contato_fk),
    CONSTRAINT condutor_cpf_key UNIQUE (cpf),
    CONSTRAINT condutor_endereco_fk_key UNIQUE (endereco_fk),
    CONSTRAINT condutor_motocicleta_fk_key UNIQUE (motocicleta_fk),
    CONSTRAINT condutor_numero_ordem_key UNIQUE (numero_ordem),
    CONSTRAINT condutor_rg_key UNIQUE (rg)
);

CREATE TABLE IF NOT EXISTS public.contato
(
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    telefone_comercial character varying(15) COLLATE pg_catalog."default",
    telefone_principal character varying(15) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT contato_pkey PRIMARY KEY (id),
    CONSTRAINT contato_telefone_comercial_key UNIQUE (telefone_comercial),
    CONSTRAINT contato_telefone_principal_key UNIQUE (telefone_principal)
);

CREATE TABLE IF NOT EXISTS public.endereco
(
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    cep character varying(10) COLLATE pg_catalog."default" NOT NULL,
    numero_residencia character varying(10) COLLATE pg_catalog."default" NOT NULL,
    bairro character varying(100) COLLATE pg_catalog."default" NOT NULL,
    complemento character varying(100) COLLATE pg_catalog."default",
    cidade character varying(255) COLLATE pg_catalog."default" NOT NULL,
    logradouro character varying(255) COLLATE pg_catalog."default" NOT NULL,
    ponto_referencia character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT endereco_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.flyway_schema_history
(
    installed_rank integer NOT NULL,
    version character varying(50) COLLATE pg_catalog."default",
    description character varying(200) COLLATE pg_catalog."default" NOT NULL,
    type character varying(20) COLLATE pg_catalog."default" NOT NULL,
    script character varying(1000) COLLATE pg_catalog."default" NOT NULL,
    checksum integer,
    installed_by character varying(100) COLLATE pg_catalog."default" NOT NULL,
    installed_on timestamp without time zone NOT NULL DEFAULT now(),
    execution_time integer NOT NULL,
    success boolean NOT NULL,
    CONSTRAINT flyway_schema_history_pk PRIMARY KEY (installed_rank)
);

CREATE TABLE IF NOT EXISTS public.funcionario
(
    data_inscricao date,
    data_nascimento date,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    id_usuario bigint,
    matricula character varying(11) COLLATE pg_catalog."default",
    cpf character varying(15) COLLATE pg_catalog."default",
    tipo_sanguineo character varying(15) COLLATE pg_catalog."default",
    nome character varying(255) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT funcionario_pkey PRIMARY KEY (id),
    CONSTRAINT funcionario_cpf_key UNIQUE (cpf),
    CONSTRAINT funcionario_id_usuario_key UNIQUE (id_usuario),
    CONSTRAINT funcionario_matricula_key UNIQUE (matricula)
);

CREATE TABLE IF NOT EXISTS public.mail
(
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    assunto character varying(255) COLLATE pg_catalog."default",
    conteudo text COLLATE pg_catalog."default",
    destinatario character varying(255) COLLATE pg_catalog."default",
    remetente character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT mail_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.moto_marca
(
    ativo boolean NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    nome_marca character varying(20) COLLATE pg_catalog."default" NOT NULL,
    descricao_marca character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT moto_marca_pkey PRIMARY KEY (id),
    CONSTRAINT moto_marca_nome_marca_key UNIQUE (nome_marca)
);

CREATE TABLE IF NOT EXISTS public.moto_modelo
(
    ativo boolean NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    marca_fk bigint NOT NULL,
    modelo_moto character varying(60) COLLATE pg_catalog."default" NOT NULL,
    descricao_modelo character varying(255) COLLATE pg_catalog."default",
    CONSTRAINT moto_modelo_pkey PRIMARY KEY (id),
    CONSTRAINT moto_modelo_modelo_moto_key UNIQUE (modelo_moto)
);

CREATE TABLE IF NOT EXISTS public.motocicleta
(
    ano_fabricacao date NOT NULL,
    ano_modelo date NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    moto_modelo_fk bigint NOT NULL,
    tipo_placa character varying(8) COLLATE pg_catalog."default",
    placa character varying(10) COLLATE pg_catalog."default" NOT NULL,
    situacao_moto character varying(13) COLLATE pg_catalog."default",
    observacao character varying(500) COLLATE pg_catalog."default",
    CONSTRAINT motocicleta_pkey PRIMARY KEY (id),
    CONSTRAINT motocicleta_placa_key UNIQUE (placa)
);

CREATE TABLE IF NOT EXISTS public.perfis
(
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    descricao character varying(255) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT perfis_pkey PRIMARY KEY (id),
    CONSTRAINT perfis_descricao_key UNIQUE (descricao)
);

CREATE TABLE IF NOT EXISTS public.ponto_moto
(
    ativo boolean NOT NULL,
    contato_fk bigint,
    endereco_fk bigint,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    nome_ponto character varying(60) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT ponto_moto_pkey PRIMARY KEY (id),
    CONSTRAINT ponto_moto_contato_fk_key UNIQUE (contato_fk),
    CONSTRAINT ponto_moto_endereco_fk_key UNIQUE (endereco_fk)
);

CREATE TABLE IF NOT EXISTS public.registro_cliente_contato
(
    cliente_id bigint NOT NULL,
    data_contato timestamp(6) without time zone NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    numero_ordem character varying(10) COLLATE pg_catalog."default" NOT NULL,
    contato_condutor character varying(15) COLLATE pg_catalog."default" NOT NULL,
    email_cliente character varying(100) COLLATE pg_catalog."default" NOT NULL,
    marca_modelo_moto character varying(150) COLLATE pg_catalog."default" NOT NULL,
    nome_cliente character varying(150) COLLATE pg_catalog."default" NOT NULL,
    nome_condutor character varying(150) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT registro_cliente_contato_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.tokens
(
    desativado boolean NOT NULL,
    data_expiracao timestamp(6) with time zone NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    usuario_id bigint,
    token character varying(255) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT tokens_pkey PRIMARY KEY (id),
    CONSTRAINT tokens_token_key UNIQUE (token)
);

CREATE TABLE IF NOT EXISTS public.usuarios
(
    ativo boolean NOT NULL,
    id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 9223372036854775807 CACHE 1 ),
    codigo_verificador character varying(100) COLLATE pg_catalog."default",
    email character varying(100) COLLATE pg_catalog."default" NOT NULL,
    senha character varying(255) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT usuarios_pkey PRIMARY KEY (id),
    CONSTRAINT usuarios_email_key UNIQUE (email)
);

CREATE TABLE IF NOT EXISTS public.usuarios_tem_perfis
(
    perfil_id bigint NOT NULL,
    usuario_id bigint NOT NULL
);

ALTER TABLE IF EXISTS public.auditoria_registros
    ADD CONSTRAINT fk7v4lo4r6ck0elk4foxm7x3sn4 FOREIGN KEY (usuario_id)
    REFERENCES public.usuarios (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.cliente
    ADD CONSTRAINT fk8jxg42jrpamh07b7186gl6jpw FOREIGN KEY (id_usuario)
    REFERENCES public.usuarios (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS cliente_id_usuario_key
    ON public.cliente(id_usuario);


ALTER TABLE IF EXISTS public.cliente
    ADD CONSTRAINT fklaceuku4pj6vd3axsu6f7gupc FOREIGN KEY (contato_fk)
    REFERENCES public.contato (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS cliente_contato_fk_key
    ON public.cliente(contato_fk);


ALTER TABLE IF EXISTS public.cliente
    ADD CONSTRAINT fknfxnjh1vyf1shyc4jmg1cdj8l FOREIGN KEY (endereco_fk)
    REFERENCES public.endereco (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS cliente_endereco_fk_key
    ON public.cliente(endereco_fk);


ALTER TABLE IF EXISTS public.condutor
    ADD CONSTRAINT fk1dmqnj9bpihxwf2s960oooytf FOREIGN KEY (ponto_fk)
    REFERENCES public.ponto_moto (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.condutor
    ADD CONSTRAINT fkghj1ge2ikrym6r5421d53ovy3 FOREIGN KEY (contato_fk)
    REFERENCES public.contato (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS condutor_contato_fk_key
    ON public.condutor(contato_fk);


ALTER TABLE IF EXISTS public.condutor
    ADD CONSTRAINT fkhffafuts6yt5vfwfrjbcw91np FOREIGN KEY (motocicleta_fk)
    REFERENCES public.motocicleta (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS condutor_motocicleta_fk_key
    ON public.condutor(motocicleta_fk);


ALTER TABLE IF EXISTS public.condutor
    ADD CONSTRAINT fkmjx54c6j20kh8wehdx66dnele FOREIGN KEY (endereco_fk)
    REFERENCES public.endereco (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS condutor_endereco_fk_key
    ON public.condutor(endereco_fk);


ALTER TABLE IF EXISTS public.condutor
    ADD CONSTRAINT fkounksoij5brap569f51cd5wq9 FOREIGN KEY (cnh_fk)
    REFERENCES public.cnh (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS condutor_cnh_fk_key
    ON public.condutor(cnh_fk);


ALTER TABLE IF EXISTS public.funcionario
    ADD CONSTRAINT fkn7lf6rcoe0p0pc198hrtxqoe FOREIGN KEY (id_usuario)
    REFERENCES public.usuarios (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS funcionario_id_usuario_key
    ON public.funcionario(id_usuario);


ALTER TABLE IF EXISTS public.moto_modelo
    ADD CONSTRAINT fkoughl0fqnrdqseil8lub141w2 FOREIGN KEY (marca_fk)
    REFERENCES public.moto_marca (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.motocicleta
    ADD CONSTRAINT fk1q4uv7npjtpjc1h144dubqvab FOREIGN KEY (moto_modelo_fk)
    REFERENCES public.moto_modelo (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.ponto_moto
    ADD CONSTRAINT fk6ldyshafvcjgy0ypmlvje3ucb FOREIGN KEY (contato_fk)
    REFERENCES public.contato (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS ponto_moto_contato_fk_key
    ON public.ponto_moto(contato_fk);


ALTER TABLE IF EXISTS public.ponto_moto
    ADD CONSTRAINT fk7nek2yrysw1mvciht4n00tobw FOREIGN KEY (endereco_fk)
    REFERENCES public.endereco (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;
CREATE INDEX IF NOT EXISTS ponto_moto_endereco_fk_key
    ON public.ponto_moto(endereco_fk);


ALTER TABLE IF EXISTS public.registro_cliente_contato
    ADD CONSTRAINT fkbkxcundusups43o7ris4hy6nn FOREIGN KEY (cliente_id)
    REFERENCES public.cliente (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.tokens
    ADD CONSTRAINT fk3lk2qjcmcoxjartjgb9mlc6kf FOREIGN KEY (usuario_id)
    REFERENCES public.usuarios (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.usuarios_tem_perfis
    ADD CONSTRAINT fkewye59sxbuklud72lsswd1mn1 FOREIGN KEY (perfil_id)
    REFERENCES public.perfis (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;


ALTER TABLE IF EXISTS public.usuarios_tem_perfis
    ADD CONSTRAINT fkg6l7ittcd3wnixu65x04veyq6 FOREIGN KEY (usuario_id)
    REFERENCES public.usuarios (id) MATCH SIMPLE
    ON UPDATE NO ACTION
    ON DELETE NO ACTION;

END;
```
